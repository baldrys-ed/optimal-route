<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>walking.json ‚Äî –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }

        .topbar {
            background: #1e293b; color: #fff;
            padding: 10px 20px;
            display: flex; align-items: center; gap: 16px;
            height: 52px; flex-shrink: 0;
        }
        .topbar .title { font-weight: 700; font-size: 1rem; }
        .topbar .sub   { color: #94a3b8; font-size: .78rem; }
        .topbar .badge-stat {
            background: #334155; color: #e2e8f0;
            border-radius: 6px; padding: 3px 10px; font-size: .78rem; font-weight: 600;
        }

        .main-layout {
            display: flex;
            height: calc(100vh - 52px);
        }

        /* ‚îÄ‚îÄ –ö–∞—Ä—Ç–∞ ‚îÄ‚îÄ */
        #map-wrap {
            flex: 1; position: relative;
            background: #e2e8f0;
        }
        #map { width: 100%; height: 100%; }
        .map-loader {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: #64748b; background: #f1f5f9;
        }

        /* ‚îÄ‚îÄ –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å ‚îÄ‚îÄ */
        #panel {
            width: 360px; flex-shrink: 0;
            display: flex; flex-direction: column;
            border-left: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .panel-section {
            padding: 12px 14px;
            border-bottom: 1px solid #f1f5f9;
            flex-shrink: 0;
        }
        .panel-label {
            font-size: .68rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: .06em; color: #94a3b8; margin-bottom: 8px;
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }
        .stat-box {
            background: #f8fafc; border: 1px solid #e2e8f0;
            border-radius: 8px; padding: 8px 10px; text-align: center;
        }
        .stat-val { font-size: 1.05rem; font-weight: 700; color: #1e293b; }
        .stat-key { font-size: .65rem; color: #94a3b8; margin-top: 2px; }

        /* –õ–µ–≥–µ–Ω–¥–∞ ‚Äî —Å—Ç–∏–ª–∏ –ø—É—Ç–∏ */
        .legend-row { display: flex; flex-wrap: wrap; gap: 6px; }
        .leg-item {
            display: flex; align-items: center; gap: 5px;
            font-size: .72rem; color: #475569;
        }
        .leg-line { width: 24px; height: 4px; border-radius: 2px; flex-shrink: 0; }
        .leg-dot  { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

        /* –°–ø–∏—Å–æ–∫ –º–∞–Ω—ë–≤—Ä–æ–≤ */
        #maneuver-list { flex: 1; overflow-y: auto; }

        .mnv {
            display: flex; align-items: flex-start; gap: 10px;
            padding: 8px 14px; cursor: pointer;
            border-bottom: 1px solid #f8fafc;
            transition: background .1s;
        }
        .mnv:hover   { background: #f8fafc; }
        .mnv.active  { background: #eff6ff; border-left: 3px solid #3b82f6; padding-left: 11px; }

        .mnv-dot {
            width: 12px; height: 12px; border-radius: 50%;
            flex-shrink: 0; margin-top: 4px;
        }
        .mnv-body { flex: 1; min-width: 0; }
        .mnv-comment { font-size: .82rem; font-weight: 600; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mnv-meta    { font-size: .7rem; color: #94a3b8; margin-top: 2px; display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
        .mnv-badge {
            display: inline-block; padding: 1px 6px;
            border-radius: 4px; font-size: .62rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: .03em;
        }

        /* Popup-–∏–Ω—Ñ–æ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        #info-box {
            position: absolute; bottom: 16px; left: 16px; z-index: 10;
            background: #1e293bdd; color: #fff;
            border-radius: 10px; padding: 10px 14px;
            font-size: .8rem; max-width: 280px;
            display: none;
            backdrop-filter: blur(4px);
        }
        #info-box .ib-title { font-weight: 700; margin-bottom: 4px; }
        #info-box .ib-row   { color: #cbd5e1; font-size: .74rem; }
    </style>
</head>
<body>

<div class="topbar">
    <div>
        <div class="title">walking.json</div>
        <div class="sub">–ü–µ—à–µ—Ö–æ–¥–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç ¬∑ 2GIS Routing API v7</div>
    </div>
    <div id="hdr-distance" class="badge-stat">‚Äî</div>
    <div id="hdr-duration" class="badge-stat">‚Äî</div>
    <div id="hdr-crossings" class="badge-stat">‚Äî –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π</div>
</div>

<div class="main-layout">

    <!-- ‚îÄ‚îÄ –ö–∞—Ä—Ç–∞ ‚îÄ‚îÄ -->
    <div id="map-wrap">
        <div id="map"></div>
        <div class="map-loader" id="map-loader">
            <div class="spinner-border text-primary mb-2" role="status" style="width:1.5rem;height:1.5rem"></div>
            <div>–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç—É 2GIS‚Ä¶</div>
        </div>
        <div id="info-box">
            <div class="ib-title" id="ib-title"></div>
            <div class="ib-row" id="ib-type"></div>
            <div class="ib-row" id="ib-attr"></div>
            <div class="ib-row" id="ib-dist"></div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å ‚îÄ‚îÄ -->
    <div id="panel">

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="panel-section">
            <div class="panel-label">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞</div>
            <div class="stats-grid" id="stats-grid"></div>
        </div>

        <!-- –õ–µ–≥–µ–Ω–¥–∞ ‚Äî —Ü–≤–µ—Ç–∞ –ª–∏–Ω–∏–π -->
        <div class="panel-section">
            <div class="panel-label">–°—Ç–∏–ª–∏ –ø—É—Ç–∏</div>
            <div class="legend-row" id="legend-styles"></div>
        </div>

        <!-- –õ–µ–≥–µ–Ω–¥–∞ ‚Äî –º–∞—Ä–∫–µ—Ä—ã -->
        <div class="panel-section">
            <div class="panel-label">–¢–∏–ø—ã –º–∞–Ω—ë–≤—Ä–æ–≤</div>
            <div class="legend-row" id="legend-markers"></div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –º–∞–Ω—ë–≤—Ä–æ–≤ -->
        <div class="panel-label" style="padding: 8px 14px 0; margin-bottom: 0;">
            –ú–∞–Ω—ë–≤—Ä—ã <span id="mnv-count" style="color:#3b82f6"></span>
        </div>
        <div id="maneuver-list"></div>

    </div>
</div>

<script>
const API_KEY = 'bc9d537e-6e92-4751-9017-fe5c28958f30';

// ‚îÄ‚îÄ –¶–≤–µ—Ç–∞ —Å—Ç–∏–ª–µ–π –≥–µ–æ–º–µ—Ç—Ä–∏–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STYLE_COLORS = {
    normal:       '#3b82f6',
    crosswalk:    '#f97316',
    park_path:    '#22c55e',
    living_zone:  '#a855f7',
    undergroundway: '#6b7280',
    archway:      '#b45309',
};
const STYLE_LABELS = {
    normal:       '–¢—Ä–æ—Ç—É–∞—Ä',
    crosswalk:    '–ó–µ–±—Ä–∞',
    park_path:    '–ü–∞—Ä–∫',
    living_zone:  '–ñ–∏–ª–∞—è –∑–æ–Ω–∞',
    undergroundway: '–ü–æ–¥–∑–µ–º–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥',
    archway:      '–ê—Ä–∫–∞',
};

// ‚îÄ‚îÄ –¶–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–∞ –ø–æ —Ç–∏–ø—É –∏ –∞—Ç—Ä–∏–±—É—Ç—É ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function markerColor(type, attribute) {
    if (type === 'pedestrian_begin') return '#22c55e';
    if (type === 'pedestrian_end')   return '#3b82f6';
    if (attribute === 'on_traffic_light') return '#16a34a';
    if (type === 'pedestrian_road_crossing') {
        if (attribute === 'onto_crosswalk') return '#f97316';
        return '#ef4444'; // no marking
    }
    if (type === 'pedestrian_crossroad') {
        if (attribute === 'onto_crosswalk') return '#eab308';
        return '#94a3b8'; // simple turn
    }
    return '#94a3b8';
}

function markerLabel(type, attribute) {
    if (type === 'pedestrian_begin') return { text: '–°—Ç–∞—Ä—Ç', bg: '#dcfce7', color: '#166534' };
    if (type === 'pedestrian_end')   return { text: '–§–∏–Ω–∏—à', bg: '#dbeafe', color: '#1e40af' };
    if (attribute === 'on_traffic_light') return { text: 'üö¶ –°–≤–µ—Ç–æ—Ñ–æ—Ä', bg: '#dcfce7', color: '#166534' };
    if (type === 'pedestrian_road_crossing') {
        if (attribute === 'onto_crosswalk') return { text: '‚ö† –ó–µ–±—Ä–∞', bg: '#ffedd5', color: '#9a3412' };
        return { text: '‚õî –ë–µ–∑ —Ä–∞–∑–º–µ—Ç–∫–∏', bg: '#fee2e2', color: '#991b1b' };
    }
    if (attribute === 'onto_crosswalk') return { text: 'üü° –ó–µ–±—Ä–∞', bg: '#fef9c3', color: '#854d0e' };
    return { text: '‚Ü™ –ü–æ–≤–æ—Ä–æ—Ç', bg: '#f1f5f9', color: '#475569' };
}

// ‚îÄ‚îÄ –ü–∞—Ä—Å–∏–Ω–≥ LINESTRING (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ 2D –∏ 3D –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseLinestring(wkt) {
    const m = wkt.match(/LINESTRING\((.+)\)/);
    if (!m) return [];
    return m[1].split(',').map(s => {
        const parts = s.trim().split(' ').map(Number);
        return [parts[0], parts[1]]; // lon, lat (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É)
    });
}

// –ü–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞ –ø–µ—Ä–≤–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ –º–∞–Ω—ë–≤—Ä–∞
function maneuverCoord(m) {
    const geom = m.outcoming_path?.geometry;
    if (!geom || !geom[0]?.selection) return null;
    const pts = parseLinestring(geom[0].selection);
    return pts[0] || null;
}

// ‚îÄ‚îÄ –ö–∞—Ä—Ç–∞ –∏ –æ–±—ä–µ–∫—Ç—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let map = null;
let mapReady = false;
let polylines = [];
let markers = [];
let maneuvers = [];
let activeManIdx = -1;

function clearMap() {
    polylines.forEach(p => p.destroy());
    markers.forEach(m => m.destroy());
    polylines = []; markers = [];
}

function initMap() {
    const loader = document.getElementById('map-loader');
    try {
        map = new mapgl.Map('map', { center: [37.62, 55.77], zoom: 11, key: API_KEY });
        loader.style.display = 'none';
        mapReady = true;
        renderMap();
    } catch(e) {
        loader.innerHTML = `<div style="color:#ef4444;font-size:2rem">‚ö†</div>
            <div style="font-weight:600">–ö–∞—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å</div>
            <div style="color:#94a3b8;font-size:.8rem;margin-top:4px">${e.message}</div>`;
    }
}

function renderMap() {
    if (!mapReady || !window.ROUTE_DATA) return;
    clearMap();

    const route = ROUTE_DATA.result[0];
    const allCoords = [];

    // –ù–∞—á–∞–ª—å–Ω—ã–π –ø–µ—à–µ—Ö–æ–¥–Ω—ã–π –æ—Ç—Ä–µ–∑–æ–∫
    const bSel = route.begin_pedestrian_path?.geometry?.selection;
    if (bSel) {
        const coords = parseLinestring(bSel);
        allCoords.push(...coords);
        if (coords.length >= 2)
            polylines.push(new mapgl.Polyline(map, { coordinates: coords, width: 4, color: '#a855f7', opacity: 0.7 }));
    }

    // –ú–∞–Ω—ë–≤—Ä—ã
    route.maneuvers.forEach((maneuver, idx) => {
        const geom = maneuver.outcoming_path?.geometry || [];

        geom.forEach(seg => {
            const coords = parseLinestring(seg.selection);
            if (coords.length < 2) return;
            allCoords.push(...coords);
            const color = STYLE_COLORS[seg.style] || STYLE_COLORS.normal;
            const width  = (seg.style === 'crosswalk') ? 6 : 4;
            polylines.push(new mapgl.Polyline(map, { coordinates: coords, width, color, opacity: 0.85 }));
        });

        // –ú–∞—Ä–∫–µ—Ä
        const coord = maneuverCoord(maneuver);
        if (coord) {
            const color = markerColor(maneuver.type, maneuver.attribute);
            const marker = new mapgl.Marker(map, { coordinates: coord, color });
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è –∫–ª–∏–∫–∞ –ø–æ —Å–ø–∏—Å–∫—É
            marker._mnvIdx = idx;
            markers.push(marker);
        }
    });

    // –ö–æ–Ω–µ—á–Ω—ã–π –ø–µ—à–µ—Ö–æ–¥–Ω—ã–π –æ—Ç—Ä–µ–∑–æ–∫
    const eSel = route.end_pedestrian_path?.geometry?.selection;
    if (eSel) {
        const coords = parseLinestring(eSel);
        allCoords.push(...coords);
        if (coords.length >= 2)
            polylines.push(new mapgl.Polyline(map, { coordinates: coords, width: 4, color: '#a855f7', opacity: 0.7 }));
    }

    // –ü–æ–¥–æ–≥–Ω–∞—Ç—å –≤–∏–¥
    if (allCoords.length > 1) {
        const lons = allCoords.map(c => c[0]);
        const lats = allCoords.map(c => c[1]);
        const cx = (Math.min(...lons) + Math.max(...lons)) / 2;
        const cy = (Math.min(...lats) + Math.max(...lats)) / 2;
        const span = Math.max(Math.max(...lons)-Math.min(...lons), Math.max(...lats)-Math.min(...lats));
        map.setCenter([cx, cy]);
        map.setZoom(span > 0.08 ? 12 : span > 0.04 ? 13 : 14);
    }
}

// ‚îÄ‚îÄ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å: –∫–ª–∏–∫ –ø–æ –º–∞–Ω—ë–≤—Ä—É ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectManeuver(idx) {
    activeManIdx = idx;
    document.querySelectorAll('.mnv').forEach((el, i) => el.classList.toggle('active', i === idx));

    const mnv = maneuvers[idx];
    const coord = maneuverCoord(mnv);
    if (coord && mapReady) {
        map.setCenter(coord);
        map.setZoom(16);
    }

    // Info box
    const box = document.getElementById('info-box');
    const lbl = markerLabel(mnv.type, mnv.attribute);
    document.getElementById('ib-title').textContent = mnv.comment || mnv.type;
    document.getElementById('ib-type').textContent  = `–¢–∏–ø: ${mnv.type}`;
    document.getElementById('ib-attr').textContent  = `–ê—Ç—Ä–∏–±—É—Ç: ${mnv.attribute || '–Ω–µ—Ç'}`;
    const dist = mnv.outcoming_path?.distance;
    const dur  = mnv.outcoming_path?.duration;
    document.getElementById('ib-dist').textContent  = dist ? `–î–∞–ª—å—à–µ: ${dist} –º ¬∑ ${dur} —Å` : '';
    box.style.display = 'block';
}

// ‚îÄ‚îÄ –†–µ–Ω–¥–µ—Ä –ø–∞–Ω–µ–ª–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPanel() {
    const route = ROUTE_DATA.result[0];
    maneuvers = route.maneuvers || [];

    // –•—ç–¥–µ—Ä
    document.getElementById('hdr-distance').textContent =
        `${route.ui_total_distance.value} ${route.ui_total_distance.unit}`;
    document.getElementById('hdr-duration').textContent = route.ui_total_duration;

    const roadCrossings = maneuvers.filter(m => m.type === 'pedestrian_road_crossing').length;
    document.getElementById('hdr-crossings').textContent = `${roadCrossings} –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –¥–æ—Ä–æ–≥`;

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    const alt = route.altitudes_info || {};
    const gainM  = alt.elevation_gain  ? (alt.elevation_gain  / 100).toFixed(0) : '‚Äî';
    const lossM  = alt.elevation_loss  ? (alt.elevation_loss  / 100).toFixed(0) : '‚Äî';
    const angleM = alt.max_road_angle  || '‚Äî';
    const lightCount = maneuvers.filter(m => m.attribute === 'on_traffic_light').length;
    const crosswalkCount = maneuvers.filter(m => m.attribute === 'onto_crosswalk').length;
    const unsafeCount = maneuvers.filter(m =>
        (m.type === 'pedestrian_road_crossing') && (!m.attribute || m.attribute === 'empty')).length;

    document.getElementById('stats-grid').innerHTML = `
        <div class="stat-box"><div class="stat-val">${route.total_distance} –º</div><div class="stat-key">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</div></div>
        <div class="stat-box"><div class="stat-val">${Math.round(route.total_duration/60)} –º–∏–Ω</div><div class="stat-key">–í—Ä–µ–º—è</div></div>
        <div class="stat-box"><div class="stat-val">${maneuvers.length}</div><div class="stat-key">–ú–∞–Ω—ë–≤—Ä–æ–≤</div></div>
        <div class="stat-box"><div class="stat-val">${roadCrossings}</div><div class="stat-key">–ü–µ—Ä–µ—Ö–æ–¥–æ–≤ –¥–æ—Ä–æ–≥</div></div>
        <div class="stat-box" style="border-color:#dcfce7"><div class="stat-val" style="color:#16a34a">${lightCount}</div><div class="stat-key">–°–≤–µ—Ç–æ—Ñ–æ—Ä–æ–≤</div></div>
        <div class="stat-box" style="border-color:#ffedd5"><div class="stat-val" style="color:#f97316">${crosswalkCount}</div><div class="stat-key">–ó–µ–±—Ä</div></div>
        <div class="stat-box" style="border-color:#fee2e2"><div class="stat-val" style="color:#ef4444">${unsafeCount}</div><div class="stat-key">–ë–µ–∑ —Ä–∞–∑–º–µ—Ç–∫–∏</div></div>
        <div class="stat-box"><div class="stat-val">‚Üë${gainM} –º</div><div class="stat-key">–ù–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã</div></div>
        <div class="stat-box"><div class="stat-val">${angleM}¬∞</div><div class="stat-key">–ú–∞–∫—Å. —É–∫–ª–æ–Ω</div></div>
    `;

    // –õ–µ–≥–µ–Ω–¥–∞ ‚Äî —Å—Ç–∏–ª–∏
    const styles = Object.entries(STYLE_COLORS).map(([key, color]) => `
        <div class="leg-item">
            <div class="leg-line" style="background:${color}"></div>
            <span>${STYLE_LABELS[key] || key}</span>
        </div>`).join('');
    document.getElementById('legend-styles').innerHTML = styles;

    // –õ–µ–≥–µ–Ω–¥–∞ ‚Äî –º–∞—Ä–∫–µ—Ä—ã
    const markerLegend = [
        { color: '#22c55e', label: '–°—Ç–∞—Ä—Ç / –§–∏–Ω–∏—à' },
        { color: '#16a34a', label: '–°–≤–µ—Ç–æ—Ñ–æ—Ä' },
        { color: '#f97316', label: '–ó–µ–±—Ä–∞ (–ø–µ—Ä–µ—Ö–æ–¥)' },
        { color: '#ef4444', label: '–ë–µ–∑ —Ä–∞–∑–º–µ—Ç–∫–∏ (–ø–µ—Ä–µ—Ö–æ–¥)' },
        { color: '#eab308', label: '–ó–µ–±—Ä–∞ (–ø–æ–≤–æ—Ä–æ—Ç)' },
        { color: '#94a3b8', label: '–û–±—ã—á–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç' },
    ].map(i => `
        <div class="leg-item">
            <div class="leg-dot" style="background:${i.color}"></div>
            <span>${i.label}</span>
        </div>`).join('');
    document.getElementById('legend-markers').innerHTML = markerLegend;

    // –°—á—ë—Ç—á–∏–∫
    document.getElementById('mnv-count').textContent = `(${maneuvers.length})`;

    // –°–ø–∏—Å–æ–∫
    document.getElementById('maneuver-list').innerHTML = maneuvers.map((mnv, idx) => {
        const lbl   = markerLabel(mnv.type, mnv.attribute);
        const color = markerColor(mnv.type, mnv.attribute);
        const dist  = mnv.outcoming_path?.distance;
        const styles = mnv.outcoming_path?.geometry?.map(g => g.style).filter((v, i, a) => a.indexOf(v) === i) || [];
        const styleChips = styles.map(s =>
            `<span style="color:${STYLE_COLORS[s]||'#94a3b8'};font-weight:700">‚óè ${STYLE_LABELS[s]||s}</span>`
        ).join(' ');

        return `<div class="mnv" onclick="selectManeuver(${idx})">
            <div class="mnv-dot" style="background:${color}"></div>
            <div class="mnv-body">
                <div class="mnv-comment">${mnv.comment || mnv.type}</div>
                <div class="mnv-meta">
                    <span class="mnv-badge" style="background:${lbl.bg};color:${lbl.color}">${lbl.text}</span>
                    ${dist ? `<span>${dist} –º</span>` : ''}
                    ${styleChips}
                </div>
            </div>
        </div>`;
    }).join('');
}

// ‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Å—Ç–∞—Ä—Ç ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
fetch('walking.json')
    .then(r => r.json())
    .then(data => {
        window.ROUTE_DATA = data;
        renderPanel();
        if (mapReady) renderMap();
    })
    .catch(err => {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å walking.json:', err);
        document.getElementById('map-loader').innerHTML =
            `<div style="color:#ef4444;font-size:2rem">‚ö†</div>
             <div>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å walking.json</div>
             <div style="color:#94a3b8;font-size:.8rem;margin-top:4px">${err.message}</div>`;
    });
</script>

<script src="https://mapgl.2gis.com/api/js?key=bc9d537e-6e92-4751-9017-fe5c28958f30"
    onload="initMap()"
    onerror="document.getElementById('map-loader').innerHTML='<div style=\'color:#f59e0b;font-size:2rem\'>‚ö†</div><div>–ö–∞—Ä—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–Ω–µ—Ç —Å–µ—Ç–∏?)</div><div style=\'color:#94a3b8;font-size:.8rem;margin-top:4px\'>–î–∞–Ω–Ω—ã–µ –Ω–∞ –ø–∞–Ω–µ–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>'"
></script>

</body>
</html>
