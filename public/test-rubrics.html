<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Тест: поиск рубрик 2GIS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8fafc; }
        pre  { font-size:.75rem; background:#f1f5f9; padding:10px; border-radius:6px; max-height:300px; overflow:auto; }
        .rubric-row { cursor:pointer; }
        .rubric-row:hover { background:#f0f4ff; }
    </style>
</head>
<body>
<div class="container py-4" style="max-width:900px">

    <h4 class="fw-bold mb-1">Тест: поиск рубрик 2GIS</h4>
    <p class="text-muted small mb-4">Шаг 1 — найти регион → Шаг 2 — найти рубрику с region_id → получить rubric_id для точного поиска</p>

    <!-- Step 1: region -->
    <div class="card mb-4">
        <div class="card-body">
            <h6 class="fw-semibold mb-3">Шаг 1: Найти region_id по городу</h6>
            <div class="input-group mb-3">
                <input type="text" id="region-q" class="form-control" value="Минеральные Воды" placeholder="Название города">
                <button class="btn btn-primary" onclick="searchRegion()">Найти регион</button>
            </div>
            <div id="region-result"></div>
        </div>
    </div>

    <!-- Step 2: rubric search -->
    <div class="card mb-4">
        <div class="card-body">
            <h6 class="fw-semibold mb-3">Шаг 2: Найти рубрику (нужен region_id из шага 1)</h6>
            <div class="row g-2 mb-3">
                <div class="col">
                    <input type="text" id="rubric-q" class="form-control" placeholder="Категория (аптека, школа, парк...)">
                </div>
                <div class="col-auto">
                    <input type="text" id="rubric-region-id" class="form-control" placeholder="region_id" style="width:120px">
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary" onclick="searchRubric()">Найти рубрику</button>
                </div>
            </div>
            <div id="rubric-result"></div>
        </div>
    </div>

    <!-- Quick search all -->
    <div class="card">
        <div class="card-body">
            <h6 class="fw-semibold mb-3">Быстрый перебор категорий</h6>
            <div class="row g-2 align-items-end mb-3">
                <div class="col-auto">
                    <input type="text" id="bulk-region-id" class="form-control" placeholder="region_id" style="width:120px">
                </div>
                <div class="col-auto">
                    <button class="btn btn-outline-primary" onclick="searchAll()">Найти все категории</button>
                </div>
            </div>
            <div id="bulk-result"></div>
        </div>
    </div>

</div>

<script>
const CATEGORIES = [
    'продуктовый магазин',
    'супермаркет',
    'аптека',
    'школа',
    'поликлиника',
    'парк',
    'спортивная площадка',
    'детская площадка',
];

async function searchRegion() {
    const q   = document.getElementById('region-q').value.trim();
    const res = await fetch(`/api/region?q=${encodeURIComponent(q)}`);
    const data = await res.json();

    const items = data.result?.items || data.items || [];
    const el = document.getElementById('region-result');

    if (!items.length) {
        el.innerHTML = `<div class="text-danger small">Ничего не найдено</div><pre>${JSON.stringify(data,null,2)}</pre>`;
        return;
    }

    el.innerHTML = `
        <table class="table table-sm table-bordered mb-2">
          <thead class="table-light"><tr><th>id</th><th>Название</th><th>Страна</th><th></th></tr></thead>
          <tbody>
            ${items.map(r => `
              <tr class="rubric-row" onclick="useRegion('${r.id}', '${(r.name||'').replace(/'/g,"\\'")}')">
                <td><code>${r.id}</code></td>
                <td>${r.name || '—'}</td>
                <td>${r.country?.name || '—'}</td>
                <td><button class="btn btn-xs btn-outline-success btn-sm py-0">Выбрать</button></td>
              </tr>`).join('')}
          </tbody>
        </table>
        <pre>${JSON.stringify(data,null,2)}</pre>`;
}

function useRegion(id, name) {
    document.getElementById('rubric-region-id').value = id;
    document.getElementById('bulk-region-id').value   = id;
    alert(`region_id = ${id} (${name}) скопирован в поля ниже`);
}

async function searchRubric() {
    const q        = document.getElementById('rubric-q').value.trim();
    const regionId = document.getElementById('rubric-region-id').value.trim();
    const params   = new URLSearchParams({ q });
    if (regionId) params.set('region_id', regionId);

    const res  = await fetch(`/api/rubric?${params}`);
    const data = await res.json();
    const items = data.result?.items || data.items || [];
    const el = document.getElementById('rubric-result');

    if (!items.length) {
        el.innerHTML = `<div class="text-danger small">Ничего не найдено</div><pre>${JSON.stringify(data,null,2)}</pre>`;
        return;
    }

    el.innerHTML = `
        <table class="table table-sm table-bordered mb-2">
          <thead class="table-light"><tr><th>id</th><th>Название рубрики</th><th>Родительская</th></tr></thead>
          <tbody>
            ${items.map(r => `
              <tr>
                <td><code class="text-primary">${r.id}</code></td>
                <td>${r.name || '—'}</td>
                <td class="text-muted small">${r.parent_rubric?.name || '—'}</td>
              </tr>`).join('')}
          </tbody>
        </table>
        <pre>${JSON.stringify(data,null,2)}</pre>`;
}

async function searchAll() {
    const regionId = document.getElementById('bulk-region-id').value.trim();
    const el = document.getElementById('bulk-result');
    el.innerHTML = '<div class="text-muted small">Ищем…</div>';

    const results = [];
    for (const cat of CATEGORIES) {
        const params = new URLSearchParams({ q: cat });
        if (regionId) params.set('region_id', regionId);
        try {
            const res  = await fetch(`/api/rubric?${params}`);
            const data = await res.json();
            const first = (data.result?.items || data.items || [])[0];
            results.push({ cat, id: first?.id || '—', name: first?.name || '—', error: data._error || null });
        } catch(e) {
            results.push({ cat, id: '—', name: '—', error: e.message });
        }
    }

    el.innerHTML = `
        <table class="table table-sm table-bordered">
          <thead class="table-light"><tr><th>Категория (q)</th><th>rubric_id</th><th>Найденная рубрика</th></tr></thead>
          <tbody>
            ${results.map(r => `
              <tr class="${r.error ? 'table-danger' : ''}">
                <td>${r.cat}</td>
                <td><code>${r.id}</code></td>
                <td>${r.error ? r.error : r.name}</td>
              </tr>`).join('')}
          </tbody>
        </table>`;
}
</script>
</body>
</html>
