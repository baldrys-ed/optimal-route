<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢–µ—Å—Ç: –ø–æ–∏—Å–∫ —Å–≤–µ—Ç–æ—Ñ–æ—Ä–æ–≤ (Catalog API)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8fafc; }
        .result-badge { font-size: .85rem; }
        pre { font-size: .75rem; background: #f1f5f9; padding: 10px; border-radius: 6px; max-height: 200px; overflow: auto; }
    </style>
</head>
<body>
<div class="container py-4" style="max-width:800px">

    <h4 class="fw-bold mb-1">–¢–µ—Å—Ç: Catalog API ‚Äî –ø–æ–∏—Å–∫ —Å–≤–µ—Ç–æ—Ñ–æ—Ä–æ–≤</h4>
    <p class="text-muted small mb-4">
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç <code>GET /api/crossing?lon=&amp;lat=&amp;radius=</code> ‚Üí
        Symfony ‚Üí <code>catalog.api.2gis.com/3.0/items?q=—Å–≤–µ—Ç–æ—Ñ–æ—Ä</code>
    </p>

    <!-- Custom coordinates -->
    <div class="card mb-4">
        <div class="card-body">
            <h6 class="fw-semibold mb-3">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</h6>
            <div class="row g-2 align-items-end">
                <div class="col">
                    <label class="form-label small">Longitude</label>
                    <input type="text" id="inp-lon" class="form-control form-control-sm" value="37.5833" placeholder="37.5833">
                </div>
                <div class="col">
                    <label class="form-label small">Latitude</label>
                    <input type="text" id="inp-lat" class="form-control form-control-sm" value="55.7752" placeholder="55.7752">
                </div>
                <div class="col">
                    <label class="form-label small">–†–∞–¥–∏—É—Å (–º)</label>
                    <input type="number" id="inp-radius" class="form-control form-control-sm" value="50">
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary btn-sm" onclick="testCustom()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                </div>
            </div>
            <div id="custom-result" class="mt-3"></div>
        </div>
    </div>

    <!-- Preset crossing points from Moscow test route -->
    <h6 class="fw-semibold mb-2">–¢–µ—Å—Ç–æ–≤—ã–µ —Ç–æ—á–∫–∏ (–ú–æ—Å–∫–≤–∞, –º–∞—Ä—à—Ä—É—Ç –¢–≤–µ—Ä—Å–∫–∞—è ‚Üí –°–∞–¥–æ–≤–∞—è)</h6>
    <div class="card">
        <div class="table-responsive">
            <table class="table table-sm mb-0">
                <thead class="table-light">
                    <tr>
                        <th>–ú–µ—Å—Ç–æ</th>
                        <th>Lon</th>
                        <th>Lat</th>
                        <th>–†–∞–¥–∏—É—Å</th>
                        <th></th>
                        <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                        <th>Raw</th>
                    </tr>
                </thead>
                <tbody id="preset-tbody">
                    <!-- rows injected by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="mt-3">
        <button class="btn btn-outline-secondary btn-sm" onclick="testAll()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ</button>
        <span class="text-muted small ms-2" id="all-status"></span>
    </div>

    <div class="mt-4 p-3 bg-white border rounded">
        <p class="fw-semibold mb-1 small">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</p>
        <ol class="small text-muted mb-0">
            <li>–ë—Ä–∞—É–∑–µ—Ä ‚Üí <code>GET /api/crossing?lon=‚Ä¶&lat=‚Ä¶&radius=50</code></li>
            <li>Symfony (ProxyController) ‚Üí <code>TwogisApiService::hasTrafficLight()</code></li>
            <li>PHP ‚Üí <code>catalog.api.2gis.com/3.0/items?q=—Å–≤–µ—Ç–æ—Ñ–æ—Ä&point=lon,lat&radius=50</code></li>
            <li>–ï—Å–ª–∏ <code>result.total &gt; 0</code> ‚Üí <strong>regulated: true</strong></li>
        </ol>
    </div>
</div>

<script>
const PRESETS = [
    { label: '–¢–≤–µ—Ä—Å–∫–∞—è –∑–∞—Å—Ç–∞–≤–∞',           lon: 37.5833, lat: 55.7752, radius: 50 },
    { label: '–°–∞–¥–æ–≤–∞—è-–¢—Ä–∏—É–º—Ñ–∞–ª—å–Ω–∞—è',        lon: 37.5977, lat: 55.7702, radius: 50 },
    { label: '–°–∞–¥–æ–≤–∞—è-–ß–µ—Ä–Ω–æ–≥—Ä—è–∑—Å–∫–∞—è',       lon: 37.6566, lat: 55.7649, radius: 50 },
    { label: '–¢–≤–µ—Ä—Å–∫–∞—è + –û—Ö–æ—Ç–Ω—ã–π –†—è–¥',      lon: 37.6144, lat: 55.7566, radius: 100 },
    { label: '–ê—Ä–±–∞—Ç (–ø–µ—à–µ—Ö–æ–¥–Ω–∞—è –∑–æ–Ω–∞)',      lon: 37.5945, lat: 55.7494, radius: 50 },
];

function renderPresets() {
    const tbody = document.getElementById('preset-tbody');
    tbody.innerHTML = PRESETS.map((p, i) => `
        <tr id="row-${i}">
            <td>${p.label}</td>
            <td><code>${p.lon}</code></td>
            <td><code>${p.lat}</code></td>
            <td>${p.radius} –º</td>
            <td>
                <button class="btn btn-outline-primary btn-sm py-0" onclick="testPreset(${i})">–¢–µ—Å—Ç</button>
            </td>
            <td id="res-${i}"><span class="text-muted">‚Äî</span></td>
            <td id="raw-${i}"></td>
        </tr>
    `).join('');
}

async function callCrossing(lon, lat, radius) {
    const url = `/api/crossing?lon=${lon}&lat=${lat}&radius=${radius}`;
    const res  = await fetch(url);
    return { status: res.status, data: await res.json() };
}

function resultBadge(data) {
    if (data._error) {
        return `<span class="badge bg-danger result-badge">–û—à–∏–±–∫–∞</span>
                <span class="text-danger small ms-1">${data._error.slice(0, 60)}</span>`;
    }
    if (data.regulated === true) {
        return `<span class="badge bg-warning text-dark result-badge">üö¶ –†–µ–≥—É–ª–∏—Ä—É–µ–º—ã–π</span>`;
    }
    return `<span class="badge bg-secondary result-badge">–ù–µ —Ä–µ–≥—É–ª–∏—Ä—É–µ–º—ã–π</span>`;
}

async function testPreset(i) {
    const p = PRESETS[i];
    document.getElementById(`res-${i}`).innerHTML = `<span class="spinner-border spinner-border-sm text-primary"></span>`;
    document.getElementById(`raw-${i}`).innerHTML = '';
    try {
        const { data } = await callCrossing(p.lon, p.lat, p.radius);
        document.getElementById(`res-${i}`).innerHTML = resultBadge(data);
        document.getElementById(`raw-${i}`).innerHTML =
            `<pre class="mb-0">${JSON.stringify(data, null, 2)}</pre>`;
    } catch (e) {
        document.getElementById(`res-${i}`).innerHTML =
            `<span class="badge bg-danger">Fetch error</span>`;
    }
}

async function testAll() {
    const statusEl = document.getElementById('all-status');
    for (let i = 0; i < PRESETS.length; i++) {
        statusEl.textContent = `–ü—Ä–æ–≤–µ—Ä—è—é ${i + 1} / ${PRESETS.length}‚Ä¶`;
        await testPreset(i);
    }
    statusEl.textContent = '–ì–æ—Ç–æ–≤–æ';
}

async function testCustom() {
    const lon    = parseFloat(document.getElementById('inp-lon').value);
    const lat    = parseFloat(document.getElementById('inp-lat').value);
    const radius = parseInt(document.getElementById('inp-radius').value, 10);
    const el     = document.getElementById('custom-result');

    if (!lon || !lat) { el.innerHTML = '<span class="text-danger small">–í–≤–µ–¥–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</span>'; return; }

    el.innerHTML = `<span class="spinner-border spinner-border-sm text-primary"></span> –ó–∞–ø—Ä–æ—Å‚Ä¶`;
    try {
        const { data } = await callCrossing(lon, lat, radius);
        el.innerHTML = `
            ${resultBadge(data)}
            <pre class="mt-2 mb-0">${JSON.stringify(data, null, 2)}</pre>`;
    } catch (e) {
        el.innerHTML = `<span class="text-danger small">–û—à–∏–±–∫–∞: ${e.message}</span>`;
    }
}

renderPresets();
</script>
</body>
</html>
